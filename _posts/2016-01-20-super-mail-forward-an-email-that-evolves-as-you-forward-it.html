---
title:  "Super Mail Forward: an email that evolves as you forward it"
date:   2016-01-20 12:45:53 +0200
---
<section name="c8dd" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f415" id="f415" class="graf graf--h3 graf--leading graf--title">Super Mail Forward : an email that evolves as you forward it</h3><p name="9700" id="9700" class="graf graf--p graf-after--h3">Last year, <a href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding" data-href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Litmus held a community contest</a> which theme was “Emails Worth Forwarding”. In order <a href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding#comment-5442" data-href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding#comment-5442" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">to participate</a>, I created an email I called <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" data-href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Super Mail Forward</a>. It’s an email you can forward between the desktop webmails of Gmail, Yahoo, Outlook.com and AOL, evolving with each forward. It’s a fantastic exercise that taught me a lot of things specific to these webmails. Here are a few details.</p><figure name="3b61" id="3b61" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.2%;"></div><img class="graf-image" data-image-id="1*lbO5CnbPiDWDhNK5FE0CtQ.png" data-width="1366" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*lbO5CnbPiDWDhNK5FE0CtQ.png"></div></figure><p name="0ad0" id="0ad0" class="graf graf--p graf-after--figure">The email is composed of four question blocks (from Super Mario World). Every time you forward the email on the expected webmail, in the right order, the first unopened block will be transformed into a mushroom of a different color. If you send the email on one of the four supported webmails, but not in the expected order, the question block corresponding to the expected position for this webmail will turn red.</p><figure name="e722" id="e722" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.2%;"></div><img class="graf-image" data-image-id="1*eMYNfEuQA5PpvjPzcFWWeQ.jpeg" data-width="1366" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*eMYNfEuQA5PpvjPzcFWWeQ.jpeg"></div><figcaption class="imageCaption">If you send the email first in Gmail, the block corresponding to Gmail’s order turns red.</figcaption></figure><p name="5e01" id="5e01" class="graf graf--p graf-after--figure">I wanted to make this exercise in order to see how many times you could forward an email before its code, transformed by webmails, would become an incomprehensible mess. And to my biggest surprise, you can go pretty far. In fact, webmails like Yahoo, Outlook.com or AOL don’t deteriorate the HTML code of an email when forwarding it more than when they receive it in the first place. This means that since Outlook.com filters the CSS <em class="markup--em markup--p-em">background-image</em> property, this property will also be absent when you forward an email from Outlook.com.</p><p name="f413" id="f413" class="graf graf--p graf-after--p">The only exception to this behavior is Gmail. On top of filtering any <em class="markup--em markup--p-em">class</em> or <em class="markup--em markup--p-em">id</em> attributes (which is in itself already pretty annoying), Gmail will remove any <em class="markup--em markup--p-em">&lt;style&gt;</em> tag and any attribute usually supported (like <em class="markup--em markup--p-em">lang</em> or <em class="markup--em markup--p-em">aria-labelledby</em>) when you forward an email. So I quickly realized that if I wanted to include Gmail in my list of webmails supported by my email, it would inevitably be in the last position. I also picked AOL as the first webmail early on, as it’s the most permissive webmail regarding styles filtering. And after a lot of tests and hesitations, I picked Yahoo in second position and Outlook.com in third position.</p><p name="23f5" id="23f5" class="graf graf--p graf-after--p">Each block of the email is composed of sixteen lines and sixteen columns. Each cell has a background color that changes depending on the current case :</p><ul class="postList"><li name="100f" id="100f" class="graf graf--li graf-after--p">either we’re on the right webmail in the expected order,</li><li name="1041" id="1041" class="graf graf--li graf-after--li">or we’re on one of the four supported webmails but not in the expected order,</li><li name="40bf" id="40bf" class="graf graf--li graf-after--li">or we’re not on one of the supported webmails.</li></ul><p name="b7d5" id="b7d5" class="graf graf--p graf-after--li">By default, each cell has a <em class="markup--em markup--p-em">background</em> property in a <em class="markup--em markup--p-em">style</em> attribute corresponding to its final state as desired in Gmail. The display in other clients is then handled with a play on classes. The final code for each cell looks like this :</p><pre name="c19c" id="c19c" class="graf graf--pre graf-after--p">&lt;td style=&quot;<em class="markup--em markup--pre-em">background:#ee1c25; background:#d89f37 url(spacer.gif);</em>&quot; class=&quot;<em class="markup--em markup--pre-em">mushroom-ee1c25 block-d89f37</em>&quot; lang=&quot;<em class="markup--em markup--pre-em">block-d89f37</em>&quot;&gt;&lt;/td&gt;</pre><h3 name="ab5f" id="ab5f" class="graf graf--h3 graf-after--pre">First step : AOL</h3><figure name="629d" id="629d" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.2%;"></div><img class="graf-image" data-image-id="1*K6h-Lvsj6VP5iNOEJZMAOQ.jpeg" data-width="1366" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*K6h-Lvsj6VP5iNOEJZMAOQ.jpeg"></div></figure><p name="2d6b" id="2d6b" class="graf graf--p graf-after--figure">When landing on AOL, the webmail prefixes each selector. Thus, the selector “<em class="markup--em markup--p-em">.foo”</em> becomes “<em class="markup--em markup--p-em">.aolReplacedBody .foo</em>”. In order to target AOL and activate the first block, I used <a href="https://github.com/hteumeuleu/email-bugs/issues/2" data-href="https://github.com/hteumeuleu/email-bugs/issues/2" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">a filtering bug on AOL</a> I discovered back then. When a <em class="markup--em markup--p-em">background</em> property contains a <em class="markup--em markup--p-em">url()</em> to an image within a <em class="markup--em markup--p-em">&lt;style&gt;</em> tag, AOL incorrectly replaces the path of this image. Thereby, the following code…</p><pre name="790d" id="790d" class="graf graf--pre graf-after--p">.block-fff {<br>   background:url(&#39;http://i.imgur.com/6qtuIRR.gif&#39;);<br>   background:#fff;<br>}</pre><p name="39f6" id="39f6" class="graf graf--p graf-after--pre">… is transformed by AOL into the following :</p><pre name="d825" id="d825" class="graf graf--pre graf-after--p">.block-fff {<br>   background-image:url(&amp;quot;&lt;a href=&quot;http://i.imgur.com/6qtuIRR.gif&amp;quot&quot; target=_blank&gt;http://i.imgur.com/6qtuIRR.gif&amp;quot&lt;/a&gt;;);<br>   background:#fff;<br>}</pre><p name="bade" id="bade" class="graf graf--p graf-after--pre">Yes. AOL adds HTML higgledy-piggledy in a styles declaration. This behavior is quite inconvenient because it will cause modern browsers to ignore any following styles. But in my case, that suit me fine, and I was able to use this bug to my advantage. With the following code, I activate the mushroom for the first question block in every browser (with the rules “<em class="markup--em markup--p-em">.step1 .mushroom-X</em>”). And then, I immediately reactive the colors of the default block for the first step (with the rules “<em class="markup--em markup--p-em">.step1 .block-Y</em>”). But thanks to the background image bug, AOL will ignore these styles, and keep the mushroom colors.</p><pre name="ed48" id="ed48" class="graf graf--pre graf-after--p">.step1 .mushroom-transparent { background:transparent!important; }<br>.step1 .mushroom-000 { background:#000; }<br>.step1 .mushroom-fff { background:#fff; }<br>.step1 .mushroom-efe3af { background:#efe3af; }<br>.step1 .mushroom-ee1c25 { background:#ee1c25; }</pre><pre name="2c3c" id="2c3c" class="graf graf--pre graf-after--pre graf--trailing">.step1 .block-fff {    <br>   background:url(‘http://i.imgur.com/6qtuIRR.gif&#39;);<br>   background:#fff;<br>}<br>.step1 .block-f8d81f { background:#f8d81f; }<br>.step1 .block-d89f37 { background:#d89f37; }<br>.step1 .block-000 { background:#000; }</pre></div></div></section><section name="9380" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="ca64" id="ca64" class="graf graf--p graf--leading">Since the making of this email, this bug was <a href="https://twitter.com/advenix/status/633400047019757568" data-href="https://twitter.com/advenix/status/633400047019757568" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">reported to AOL</a> and they recently fixed it ! This is a good news, of course, except that this means my forwardable email wouldn’t work anymore. Fortunately, I was able to find another hack in order to target AOL. Turns out AOL will remove any <em class="markup--em markup--p-em">&lt;style&gt;</em> tag that contains what it interprets as a wrong image URL for a background. Thus the following styles, redefining the colors of the question block, will be completely removed by AOL.</p><pre name="673e" id="673e" class="graf graf--pre graf-after--p graf--trailing">&lt;style type=”text/css”&gt;<br>   .step1 { background:url(‘#’); }<br>   .step1 .W { background:#fff!important; }<br>   .step1 .X { background:#f8d81f!important; }<br>   .step1 .Y { background:#d89f37!important; }<br>   .step1 .Z { background:#000!important; }<br>&lt;/style&gt;</pre></div></div></section><section name="9df6" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1fbf" id="1fbf" class="graf graf--h3 graf--leading">Second step : Yahoo</h3><figure name="7454" id="7454" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.2%;"></div><img class="graf-image" data-image-id="1*3k0EE1ZivDj4VrPdzSuXpw.jpeg" data-width="1366" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*3k0EE1ZivDj4VrPdzSuXpw.jpeg"></div></figure><p name="825d" id="825d" class="graf graf--p graf-after--figure">When landing on Yahoo, the webmail once again prefixes each selector. The initial “<em class="markup--em markup--p-em">.foo</em>” selector now looks like the following.</p><pre name="8819" id="8819" class="graf graf--pre graf-after--p">#yiv9876543210 .yiv9876543210aolReplacedBody .yiv9876543210foo { }</pre><p name="f9e7" id="f9e7" class="graf graf--p graf-after--pre">Targeting Yahoo is a bit easier. Since last march, <a href="http://freshinbox.com/blog/yahoo-mail-fixes-media-query-bug-yahoo/" data-href="http://freshinbox.com/blog/yahoo-mail-fixes-media-query-bug-yahoo/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Yahoo supports media queries</a>. But not every media queries. And when it encounters an unknown type of media, Yahoo will remove the aforementioned type. Thus, the following CSS code…</p><pre name="6c06" id="6c06" class="graf graf--pre graf-after--p">@media yahoo {<br>   .step2 .mushroom-fff { background:#fff; }<br>}</pre><p name="7ae0" id="7ae0" class="graf graf--p graf-after--pre">… is transformed by Yahoo into :</p><pre name="ab3d" id="ab3d" class="graf graf--pre graf-after--p">@media {<br>   .step2 .mushroom-fff { background:#fff; }<br>}</pre><p name="6160" id="6160" class="graf graf--p graf-after--pre">The styles contained in this media query will then only apply on Yahoo, and stay there for the next forward.</p><h3 name="989d" id="989d" class="graf graf--h3 graf-after--p">Third step : Outlook.com</h3><figure name="3563" id="3563" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.2%;"></div><img class="graf-image" data-image-id="1*J3Lbq-BlDlTei1aUteWr0Q.jpeg" data-width="1366" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*J3Lbq-BlDlTei1aUteWr0Q.jpeg"></div></figure><p name="341a" id="341a" class="graf graf--p graf-after--figure">When landing on Outlook.com, the webmail once again prefixes each selector. The initial “<em class="markup--em markup--p-em">.foo</em>” selector, transformed by AOL, then by Yahoo, and then by Outlook.com now looks like the following :</p><pre name="bf79" id="bf79" class="graf graf--pre graf-after--p">#ecxyiv9876543210 .ecxyiv9876543210aolReplacedBody .ecxyiv9876543210foo { }</pre><p name="7f69" id="7f69" class="graf graf--p graf-after--pre">In order to persist until the next forward to Gmail, the activation of the mushroom on Outlook.com is handled with inline styles. Since the beginning, a second <em class="markup--em markup--p-em">background</em> property with an image was used to force the colors of the default block for this step. Outlook.com will remove this second property, leaving only the first one with the desired background color. The code of the following cell…</p><pre name="aca0" id="aca0" class="graf graf--pre graf-after--p">&lt;td style=”background:#ee1c25; background:#d89f37 url(spacer.gif);”&gt;&lt;/td&gt;</pre><p name="734c" id="734c" class="graf graf--p graf-after--pre">… is thereby transformed by Outlook.com into :</p><pre name="cdbf" id="cdbf" class="graf graf--pre graf-after--p">&lt;td style=”background:#ee1c25;”&gt;&lt;/td&gt;</pre><p name="6a32" id="6a32" class="graf graf--p graf-after--pre graf--trailing">The problem is that this also applies for the last question block (supposed to be triggered only in Gmail). In order to fix this, I redefined styles in a <em class="markup--em markup--p-em">&lt;style&gt;</em> tag with the colors of the default question block.</p></div></div></section><section name="ab82" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="b077" id="b077" class="graf graf--p graf--leading">Since the making of this email, Microsoft started phasing out Outlook.com to replace it with the same webmail as Office 365. In order to target Outlook.com to display a red question block when the email is not sent in the correct order, I used some CSS rules prefixed by “<em class="markup--em markup--p-em">.ecx</em>”. Since this was done only on Outlook.com, I had to find another way to target the new Outlook Web App client. It turns out that it will strip any attribute selector in a CSS rule. Thus, the following selector :</p><pre name="eb80" id="eb80" class="graf graf--pre graf-after--p">[owa] .W { background:#fff!important; }</pre><p name="8498" id="8498" class="graf graf--p graf-after--pre">… is transformed into :</p><pre name="f717" id="f717" class="graf graf--pre graf-after--p">.W { background:#fff!important; }</pre><p name="1d56" id="1d56" class="graf graf--p graf-after--pre graf--trailing">This is a pretty convenient way to target only Outlook Web App clients.</p></div></div></section><section name="fac8" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="71da" id="71da" class="graf graf--h3 graf--leading">Final step : Gmail</h3><figure name="5bd8" id="5bd8" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 461px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 65.9%;"></div><img class="graf-image" data-image-id="1*Lj_tcaDeM_rQ1-11WZOz9g.jpeg" data-width="1366" data-height="900" src="https://cdn-images-1.medium.com/max/800/1*Lj_tcaDeM_rQ1-11WZOz9g.jpeg"></div><figcaption class="imageCaption">Voilà !</figcaption></figure><p name="2f98" id="2f98" class="graf graf--p graf-after--figure">When landing on Gmail, all the <em class="markup--em markup--p-em">class</em> attributes in the HTML are removed. There’s no longer any rule in a <em class="markup--em markup--p-em">&lt;style&gt;</em> tag that applies. Only inline styles are left, corresponding to the final result desired.</p><h3 name="6d98" id="6d98" class="graf graf--h3 graf-after--p">Optimizations</h3><p name="4fee" id="4fee" class="graf graf--p graf-after--h3">The longest part in creating this email was optimizing the code in order to not exceed <a href="http://www.emailonacid.com/blog/details/C13/how_does_email_file_size_affect_deliverability" data-href="http://www.emailonacid.com/blog/details/C13/how_does_email_file_size_affect_deliverability" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">the 100Kb limit above which webmails block part of the content</a>. My first version was way above 160Kb. So I applied the following optimizations :</p><ul class="postList"><li name="e7a4" id="e7a4" class="graf graf--li graf-after--p">Use <em class="markup--em markup--li-em">lang</em> attributes instead of <em class="markup--em markup--li-em">aria-labelledby</em> <a href="http://freshinbox.com/blog/interactive-emails-in-gmail-using-css-attribute-selectors/" data-href="http://freshinbox.com/blog/interactive-emails-in-gmail-using-css-attribute-selectors/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">for Gmail</a>. This makes eleven characters less for every single cell.</li><li name="3697" id="3697" class="graf graf--li graf-after--li">Use shorter class names. I preferred using <em class="markup--em markup--li-em">.A</em>, <em class="markup--em markup--li-em">.B</em>, <em class="markup--em markup--li-em">.C</em>, … instead of <em class="markup--em markup--li-em">.mushroom-black</em>, <em class="markup--em markup--li-em">.mushroom-white</em>, <em class="markup--em markup--li-em">.mushroom-red</em>, …</li><li name="0ac3" id="0ac3" class="graf graf--li graf-after--li">Optimize the pixels grid in order to merge cells having a same color on both models (block and mushroom). The pixel grid is now composed of 155 cells, instead of 256. It’s probably the most efficient optimization I made, but also the most complex to set up. In the end, the grid looks like <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2015/08/smf-grille.png" data-href="http://emails.hteumeuleu.fr/wp-content/uploads/2015/08/smf-grille.png" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">this</a> :</li></ul><figure name="3c72" id="3c72" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 404px; max-height: 164px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.6%;"></div><img class="graf-image" data-image-id="1*cwfjp3r13ycNkHN0tcUh1g.png" data-width="404" data-height="164" src="https://cdn-images-1.medium.com/max/800/1*cwfjp3r13ycNkHN0tcUh1g.png"></div></figure><h3 name="48cc" id="48cc" class="graf graf--h3 graf-after--figure">Conclusion</h3><p name="cb9b" id="cb9b" class="graf graf--p graf-after--h3">I spent around eight hours to create this email. Half of that time was spent to create a proof of concept, and the other half was to reproduce the pixel art and fine tune everything. The result is still very experimental, and I doubt there’s any application for this in a real email without spending another whole lot of time. But this was a fun way to learn new things. And it even helped AOL to fix a bug in their parser along the way !</p><p name="f4ea" id="f4ea" class="graf graf--p graf-after--p">You can <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" data-href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">grab the full code of the final version here</a>. Try playing with it and sending it to your own email adresses with services like <a href="http://www.putsmail.com" data-href="http://www.putsmail.com" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Putsmail</a>.</p><p name="9a10" id="9a10" class="graf graf--p graf-after--p graf--trailing"><em class="markup--em markup--p-em">This article was first published in french </em><a href="http://emails.hteumeuleu.fr/2015/08/super-mail-forward-un-email-transferable-evolutif/" data-href="http://emails.hteumeuleu.fr/2015/08/super-mail-forward-un-email-transferable-evolutif/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">on my blog in August 2015</em></a><em class="markup--em markup--p-em">.</em></p></div></div></section>
</section>