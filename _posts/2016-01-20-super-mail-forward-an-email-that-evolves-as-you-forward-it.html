---
title:  "Super Mail Forward: an email that evolves as you forward it"
date:   2016-01-20 12:45:53 +0200
favorite: true
---
<p id="9700">Last year, <a href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding" rel="noopener" target="_blank">Litmus held a community contest</a> which theme was “Emails Worth Forwarding”. In order <a href="https://litmus.com/community/discussions/3969-community-contest-emails-worth-forwarding#comment-5442" rel="noopener" target="_blank">to participate</a>, I created an email I called <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" rel="noopener" target="_blank">Super Mail Forward</a>. It’s an email you can forward between the desktop webmails of Gmail, Yahoo, Outlook.com and AOL, evolving with each forward. It’s a fantastic exercise that taught me a lot of things specific to these webmails. Here are a few details.</p>
<figure id="3b61" class="figure--large"><img width="800" height="449" alt="" src="https://cdn-images-1.medium.com/max/800/1*lbO5CnbPiDWDhNK5FE0CtQ.png"></figure>
<p id="0ad0">The email is composed of four question blocks (from Super Mario World). Every time you forward the email on the expected webmail, in the right order, the first unopened block will be transformed into a mushroom of a different color. If you send the email on one of the four supported webmails, but not in the expected order, the question block corresponding to the expected position for this webmail will turn red.</p>
<figure id="e722"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*eMYNfEuQA5PpvjPzcFWWeQ.jpeg"><figcaption>If you send the email first in Gmail, the block corresponding to Gmail’s order turns red.</figcaption></figure>
<p id="5e01">I wanted to make this exercise in order to see how many times you could forward an email before its code, transformed by webmails, would become an incomprehensible mess. And to my biggest surprise, you can go pretty far. In fact, webmails like Yahoo, Outlook.com or AOL don’t deteriorate the HTML code of an email when forwarding it more than when they receive it in the first place. This means that since Outlook.com filters the CSS <code>background-image</code> property, this property will also be absent when you forward an email from Outlook.com.</p>
<p id="f413">The only exception to this behavior is Gmail. On top of filtering any <code>class</code> or <code>id</code> attributes (which is in itself already pretty annoying), Gmail will remove any <code>&lt;style&gt;</code> tag and any attribute usually supported (like <code>lang</code> or <code>aria-labelledby</code>) when you forward an email. So I quickly realized that if I wanted to include Gmail in my list of webmails supported by my email, it would inevitably be in the last position. I also picked AOL as the first webmail early on, as it’s the most permissive webmail regarding styles filtering. And after a lot of tests and hesitations, I picked Yahoo in second position and Outlook.com in third position.</p>
<p id="23f5">Each block of the email is composed of sixteen lines and sixteen columns. Each cell has a background color that changes depending on the current case :</p>
<ul>
<li id="100f">either we’re on the right webmail in the expected order,</li>
<li id="1041">or we’re on one of the four supported webmails but not in the expected order,</li>
<li id="40bf">or we’re not on one of the supported webmails.</li></ul>
<p id="b7d5">By default, each cell has a <code>background</code> property in a <code>style</code> attribute corresponding to its final state as desired in Gmail. The display in other clients is then handled with a play on classes. The final code for each cell looks like this :</p>
<pre id="c19c"><code>&lt;td style=&quot;background:#ee1c25; background:#d89f37 url(spacer.gif);&quot; class=&quot;mushroom-ee1c25 block-d89f37&quot; lang=&quot;block-d89f37&quot;&gt;&lt;/td&gt;</code></pre><h2 id="ab5f">First step : AOL</h2><figure id="629d"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*K6h-Lvsj6VP5iNOEJZMAOQ.jpeg"></figure>
<p id="2d6b">When landing on AOL, the webmail prefixes each selector. Thus, the selector <code>.foo</code> becomes <code>.aolReplacedBody .foo</code>. In order to target AOL and activate the first block, I used <a href="https://github.com/hteumeuleu/email-bugs/issues/2" rel="noopener" target="_blank">a filtering bug on AOL</a> I discovered back then. When a <code>background</code> property contains a <code>url()</code> to an image within a <code>&lt;style&gt;</code> tag, AOL incorrectly replaces the path of this image. Thereby, the following code…</p>
<pre id="790d"><code>.block-fff {<br>   background:url(&#39;http://i.imgur.com/6qtuIRR.gif&#39;);<br>   background:#fff;<br>}</code></pre>
<p id="39f6">… is transformed by AOL into the following :</p>
<pre id="d825"><code>.block-fff {<br>   background-image:url(&amp;quot;&lt;a href=&quot;http://i.imgur.com/6qtuIRR.gif&amp;quot&quot; target=_blank&gt;http://i.imgur.com/6qtuIRR.gif&amp;quot&lt;/a&gt;;);<br>   background:#fff;<br>}</code></pre>
<p id="bade">Yes. AOL adds HTML higgledy-piggledy in a styles declaration. This behavior is quite inconvenient because it will cause modern browsers to ignore any following styles. But in my case, that suit me fine, and I was able to use this bug to my advantage. With the following code, I activate the mushroom for the first question block in every browser (with the rules <code>.step1 .mushroom-X</code>). And then, I immediately reactive the colors of the default block for the first step (with the rules <code>.step1 .block-Y</code>). But thanks to the background image bug, AOL will ignore these styles, and keep the mushroom colors.</p>
<pre id="ed48"><code>.step1 .mushroom-transparent { background:transparent!important; }<br>.step1 .mushroom-000 { background:#000; }<br>.step1 .mushroom-fff { background:#fff; }<br>.step1 .mushroom-efe3af { background:#efe3af; }<br>.step1 .mushroom-ee1c25 { background:#ee1c25; }</code></pre>
<pre id="2c3c"><code>.step1 .block-fff {    <br>   background:url(‘http://i.imgur.com/6qtuIRR.gif&#39;);<br>   background:#fff;<br>}<br>.step1 .block-f8d81f { background:#f8d81f; }<br>.step1 .block-d89f37 { background:#d89f37; }<br>.step1 .block-000 { background:#000; }</code></pre><hr>
<p id="ca64">Since the making of this email, this bug was <a href="https://twitter.com/advenix/status/633400047019757568" rel="noopener" target="_blank">reported to AOL</a> and they recently fixed it ! This is a good news, of course, except that this means my forwardable email wouldn’t work anymore. Fortunately, I was able to find another hack in order to target AOL. Turns out AOL will remove any <code>&lt;style&gt;</code> tag that contains what it interprets as a wrong image URL for a background. Thus the following styles, redefining the colors of the question block, will be completely removed by AOL.</p>
<pre id="673e"><code>&lt;style type=”text/css”&gt;<br>   .step1 { background:url(‘#’); }<br>   .step1 .W { background:#fff!important; }<br>   .step1 .X { background:#f8d81f!important; }<br>   .step1 .Y { background:#d89f37!important; }<br>   .step1 .Z { background:#000!important; }<br>&lt;/style&gt;</code></pre><hr><h2 id="1fbf">Second step : Yahoo</h2><figure id="7454"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*3k0EE1ZivDj4VrPdzSuXpw.jpeg"></figure>
<p id="825d">When landing on Yahoo, the webmail once again prefixes each selector. The initial <code>.foo</code> selector now looks like the following.</p>
<pre id="8819"><code>#yiv9876543210 .yiv9876543210aolReplacedBody .yiv9876543210foo { }</code></pre>
<p id="f9e7">Targeting Yahoo is a bit easier. Since last march, <a href="http://freshinbox.com/blog/yahoo-mail-fixes-media-query-bug-yahoo/" rel="noopener" target="_blank">Yahoo supports media queries</a>. But not every media queries. And when it encounters an unknown type of media, Yahoo will remove the aforementioned type. Thus, the following CSS code…</p>
<pre id="6c06"><code>@media yahoo {<br>   .step2 .mushroom-fff { background:#fff; }<br>}</code></pre>
<p id="7ae0">… is transformed by Yahoo into :</p>
<pre id="ab3d"><code>@media {<br>   .step2 .mushroom-fff { background:#fff; }<br>}</code></pre>
<p id="6160">The styles contained in this media query will then only apply on Yahoo, and stay there for the next forward.</p>
<h2 id="989d">Third step : Outlook.com</h2><figure id="3563"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*J3Lbq-BlDlTei1aUteWr0Q.jpeg"></figure>
<p id="341a">When landing on Outlook.com, the webmail once again prefixes each selector. The initial <code>.foo</code> selector, transformed by AOL, then by Yahoo, and then by Outlook.com now looks like the following :</p>
<pre id="bf79"><code>#ecxyiv9876543210 .ecxyiv9876543210aolReplacedBody .ecxyiv9876543210foo { }</code></pre>
<p id="7f69">In order to persist until the next forward to Gmail, the activation of the mushroom on Outlook.com is handled with inline styles. Since the beginning, a second <code>background</code> property with an image was used to force the colors of the default block for this step. Outlook.com will remove this second property, leaving only the first one with the desired background color. The code of the following cell…</p>
<pre id="aca0"><code>&lt;td style=”background:#ee1c25; background:#d89f37 url(spacer.gif);”&gt;&lt;/td&gt;</code></pre>
<p id="734c">… is thereby transformed by Outlook.com into :</p>
<pre id="cdbf"><code>&lt;td style=”background:#ee1c25;”&gt;&lt;/td&gt;</code></pre>
<p id="6a32">The problem is that this also applies for the last question block (supposed to be triggered only in Gmail). In order to fix this, I redefined styles in a <code>&lt;style&gt;</code> tag with the colors of the default question block.</p>
<hr>
<p id="b077">Since the making of this email, Microsoft started phasing out Outlook.com to replace it with the same webmail as Office 365. In order to target Outlook.com to display a red question block when the email is not sent in the correct order, I used some CSS rules prefixed by <code>.ecx</code>. Since this was done only on Outlook.com, I had to find another way to target the new Outlook Web App client. It turns out that it will strip any attribute selector in a CSS rule. Thus, the following selector :</p>
<pre id="eb80"><code>[owa] .W { background:#fff!important; }</code></pre>
<p id="8498">… is transformed into :</p>
<pre id="f717"><code>.W { background:#fff!important; }</code></pre>
<p id="1d56">This is a pretty convenient way to target only Outlook Web App clients.</p>
<hr><h2 id="71da">Final step : Gmail</h2><figure id="5bd8"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*Lj_tcaDeM_rQ1-11WZOz9g.jpeg"><figcaption>Voilà !</figcaption></figure>
<p id="2f98">When landing on Gmail, all the <code>class</code> attributes in the HTML are removed. There’s no longer any rule in a <code>&lt;style&gt;</code> tag that applies. Only inline styles are left, corresponding to the final result desired.</p>
<h2 id="6d98">Optimizations</h2>
<p id="4fee">The longest part in creating this email was optimizing the code in order to not exceed <a href="http://www.emailonacid.com/blog/details/C13/how_does_email_file_size_affect_deliverability" rel="noopener" target="_blank">the 100Kb limit above which webmails block part of the content</a>. My first version was way above 160Kb. So I applied the following optimizations :</p>
<ul>
<li id="e7a4">Use <code>lang</code> attributes instead of <code>aria-labelledby</code> <a href="http://freshinbox.com/blog/interactive-emails-in-gmail-using-css-attribute-selectors/" rel="noopener" target="_blank">for Gmail</a>. This makes eleven characters less for every single cell.</li>
<li id="3697">Use shorter class names. I preferred using <code>.A</code>, <code>.B</code>, <code>.C</code>, … instead of <code>.mushroom-black</code>, <code>.mushroom-white</code>, <code>.mushroom-red</code>, …</li>
<li id="0ac3">Optimize the pixels grid in order to merge cells having a same color on both models (block and mushroom). The pixel grid is now composed of 155 cells, instead of 256. It’s probably the most efficient optimization I made, but also the most complex to set up. In the end, the grid looks like <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2015/08/smf-grille.png" rel="noopener" target="_blank">this</a> :</li></ul><figure id="3c72"><img alt="" src="https://cdn-images-1.medium.com/max/800/1*cwfjp3r13ycNkHN0tcUh1g.png"></figure><h2 id="48cc">Conclusion</h2>
<p id="cb9b">I spent around eight hours to create this email. Half of that time was spent to create a proof of concept, and the other half was to reproduce the pixel art and fine tune everything. The result is still very experimental, and I doubt there’s any application for this in a real email without spending another whole lot of time. But this was a fun way to learn new things. And it even helped AOL to fix a bug in their parser along the way !</p>
<p id="f4ea">You can <a href="http://emails.hteumeuleu.fr/wp-content/uploads/2016/01/super-mail-forward.html" rel="noopener" target="_blank">grab the full code of the final version here</a>. Try playing with it and sending it to your own email adresses with services like <a href="http://www.putsmail.com" rel="noopener" target="_blank">Putsmail</a>.</p>
<div class="alert">
<p id="9a10">This article was first published in french <a href="http://emails.hteumeuleu.fr/2015/08/super-mail-forward-un-email-transferable-evolutif/" rel="noopener" target="_blank"> on my blog in August 2015</a>.</p>
</div>